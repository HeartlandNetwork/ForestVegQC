---
title: "Forest Vegetation Tree QC"
author: "John Paul Schmit"
date: "5/19/2020"
output: html_document
---


```{r tree_setup, include=F}
TotTrees<-nrow(QCTrees) #Total Number of tree records checked
TotStems<-nrow(QCStems) #Total number of stem records checked


Trees_Bad_Status<-QCTrees %>% filter(is.na(Status) | !Status %in% c(Live_Status, Dead_Status, Missing_Status, Other_Status) ) %>%
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status)

Trees_No_Name<-QCTrees %>% filter(Latin_Name=="") %>%
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name)

Trees_Bad_Tag<-QCTrees %>% filter(is.na(Tag) | Tag < 1 | Tag>30000) %>%
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name)

## Crown class

Trees_Live_Bad_Crown<-QCTrees %>% filter(Status %in% Live_Status & (Crown_Description=="" | !Crown_Description %in% 
   c("Co-dominant", "Dominant", "Edge Tree", "Intermediate", "Light Gap Exploiter", "Open-grown", "Overtopped" ))) %>%
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, Crown_Description)

Trees_Unalive_Bad_Crown<-QCTrees %>% filter(!Status %in% Live_Status & Crown_Description!="") %>%
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, Crown_Description)



## DBH
Trees_Bad_DBH_Check <-QCTrees %>% filter( (Sample_Year<2018 & DBH_Check) | 
      (Sample_Year>2017 & DBH_Check & 
          Status %in% c(Missing_Status, "Dead Fallen", "Dead Missing", "Dead - Too Small", Other_Status))) %>% 
    select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, DBH_Check)

Trees_Live_Bad_DBH<-QCTrees %>% filter(Status %in% Live_Status & (
   (is.na(Equiv_Live_DBH_cm) | Equiv_Live_DBH_cm < 10 | is.na(Equiv_Dead_DBH_cm) | ( Equiv_Dead_DBH_cm>0 & Equiv_Dead_DBH_cm < 10)) ))  %>% 
   select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, Equiv_Live_DBH_cm, Equiv_Dead_DBH_cm)

Trees_Dead_Bad_DBH<-QCTrees %>% filter(Status %in% c("Dead Leaning", "Dead Standing") & (
   (is.na(Equiv_Dead_DBH_cm) | Equiv_Dead_DBH_cm < 10 | is.na(Equiv_Live_DBH_cm) | Equiv_Live_DBH_cm>=10 |
      ( Equiv_Live_DBH_cm >0 & Equiv_Live_DBH_cm < 1)) ))  %>% 
   select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, Equiv_Live_DBH_cm, Equiv_Dead_DBH_cm)

Trees_Other_Bad_DBH<-QCTrees %>% filter(Status %in% c(Missing_Status, Other_Status, 
    "Dead", "Dead - Human Action", "Dead - Too Small", "Dead Fallen", "Dead Missing") & (
   (is.na(Equiv_Dead_DBH_cm) |is.na(Equiv_Live_DBH_cm) | Equiv_Live_DBH_cm!=0 |
       Equiv_Dead_DBH_cm !=0 )) )  %>% 
   select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, Equiv_Live_DBH_cm, Equiv_Dead_DBH_cm)

Tree_Stems_Live_Bad_DBH<-QCStems %>% filter(Sample_Year %in% QCYears, Live==T, Class=="Tree", (is.na(DBH) | DBH<1)) %>% 
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, DBH, Live )

Tree_Stems_Dead_Bad_DBH<-QCStems %>% filter(Sample_Year %in% QCYears, Live==F,  Class=="Tree", (is.na(DBH) | DBH<10)) %>% 
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, DBH, Live )

Tree_Stems_Other_Bad_DBH<-QCStems %>% filter(Sample_Year %in% QCYears, Class=="Tree", Status %in% c(Missing_Status, Other_Status, 
    "Dead", "Dead - Human Action", "Dead - Too Small", "Dead Fallen", "Dead Missing")) %>% 
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, DBH, Live )


## Vigor
Trees_Live_Bad_Vigor<-QCTrees %>% filter(Status %in% Live_Status & 
      ( (Sample_Year<2017 & VigorClass!="") | (Sample_Year >=2017 & VigorClass=="")  | 
          (Sample_Year >=2017 & !VigorClass %in% Vigor_Options)  |is.na(VigorClass)) ) %>% 
   select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, TreeVigor, VigorClass)

Trees_Unalive_Bad_Vigor<-QCTrees %>% filter(!Status %in% Live_Status, !VigorClass %in% "") %>% 
   select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, TreeVigor, VigorClass)

## Foliage
Trees_Bad_Foliage_Condition<-QCFoliage %>% filter(Sample_Year  %in% QCYears & (is.na(Condition_Description) | 
              !Condition_Description %in% c("Chlorosis","Holes","Necrosis","Small leaves","Wilting","Other") )) %>% 
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Condition_Description, Percent_Afflicted)
  

Trees_Bad_Foliage_Percent<-QCFoliage %>% filter(Sample_Year  %in% QCYears & (is.na(Percent_Afflicted) | 
                            Percent_Afflicted<1 |Percent_Afflicted>100)) %>% 
    select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Condition_Description, Percent_Afflicted)

Trees_Unalive_Foliage<- QCFoliage %>% filter(Sample_Year %in% QCYears & !Status %in% Live_Status ) %>% 
    select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, Condition_Description, Percent_Afflicted)


## Tree Conditions
Trees_Live_Bad_Tree_Condition<-QCConditions %>% filter( (Sample_Year %in% QCYears) & !Pest & (Status %in% Live_Status) &
  !Condition %in% c("Advanced decay", "Primary branch broken",  "Large dead branches", "Lightning Damage", "Wind Damage", "Buck Rub", "Bark Damage",
                    "Beaver Damage", "Human Damage", "Mammal Damage", "Bird Damage", "Exposed roots", "Epicormic sprouts", "Fungus", "Fire", "Hollow",
                    "Sparse foliage", "Open wound", "Vines in the crown",  "Vine stress", "Other visible condition", "Other visible damage")) %>% 
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Condition)

Trees_Live_Anachronistic_Tree_Conditions<-QCConditions %>% filter( (Sample_Year %in% QCYears) & !Pest & (Status %in% Live_Status) &
      (
        (Condition =="Lightning Damage" & Sample_Year< 2009) | 
          (Condition %in% c("Buck Rub", "Bark Damage", "Human Damage") & Sample_Year < 2014) |
          (Condition =="Beaver Damage" & !Sample_Year %in% 2014:2016) |
          (Condition =="Epicormic Sprouts" & Sample_Year< 2015) |
          (Condition %in% c("Mammal Damage", "Bird Damage", "Exposed roots", "Fungus", "Fire", "Hollow", "Sparse foliage",
                            "Other visible condition") & Sample_Year < 2017) |
          (Condition =="Vine Stress" & Sample_Year< 2015) |
         (Condition =="Other visible damage" & Sample_Year> 2016)
        )) %>%   select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Condition)


Trees_Unalive_Tree_Conditions<-QCConditions %>% filter( (Sample_Year %in% QCYears) & !Pest & 
                (Status %in% c(Dead_Status, Missing_Status, Other_Status))) %>% 
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, Condition)

## Tree Pests

Trees_Live_Bad_Pest<-QCConditions %>% filter( (Sample_Year %in% QCYears) & Pest & (Status %in% Live_Status) &
  !Condition %in% c("Asian longhorned beetle", "Beech bark disease",  "Butternut canker", "Chestnut blight", "Dogwood anthracnose", 
                    "Emerald ash borer", "Gypsy moth","Hemlock Scale", "Hemlock wooly adelgid", "Oak wilt", "Spotted lanternfly", 
                    "Thousand cankers disease", "Tent caterpillars", "Other significant insect damage")) %>% 
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Condition)

Trees_Live_Anachronistic_Pest<-QCConditions %>% filter( (Sample_Year %in% QCYears) & Pest & (Status %in% Live_Status) &
      (
        (Condition %in% c("Dogwood anthracnose","Hemlock Scale") & Sample_Year< 2008) | 
          (Condition =="Emrerald ash borer" & Sample_Year < 2009) |
          (Condition %in% c("Asian longhotnrf beetle","Chestnut blight", "Oak wilt", "Thousand cankers disease") & Sample_Year < 2014) |
          (Condition =="Tent caterpillars" & Sample_Year< 2017) |
          (Condition =="Spotted lanternfly" & Sample_Year < 2018))
    ) %>%   select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Condition)


Trees_Unalive_Pest<-QCConditions %>% filter( (Sample_Year %in% QCYears) & Pest & Condition !="Emerald ash borer" &
                (Status %in% c(Dead_Status, Missing_Status, Other_Status) )) %>% 
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, Condition)

Trees_Pest_Bad_Host<-QCConditions %>% filter((Sample_Year %in% QCYears) & Pest & 
  (
   (Condition == "Beach bark disease" & Latin_Name !="Fagus grandifolia") |
    (Condition =="Butternut canker" & Latin_Name != "Junglans cinerea") |
    (Condition == "Chestnut blight" & Latin_Name != "Castanea dentata") |
    (Condition == "Dogwood anthracnose" & Latin_Name != "Cornus florida") |
    (Condition =="Emerald ash borer" & !Latin_Name %in% c("Fraxinus americana", "Fraxinus nigra", "Fraxinus pennsylvanica", "Fraxinus profunda")) |
    (Condition %in% c("Hemlock Scale", "Hemlock wooly adelgid") & Latin_Name != "Tsuga canadensis") |
    (Condition =="Thousand cankers disease" & Latin_Name !="Juglans nigra")
  )) %>% select(Unit_Code, Plot_Name, Sample_Year, Tag, Latin_Name, Status, Condition)

Trees_Bad_Vines<-QCConditions %>% filter((Sample_Year %in% QCYears) & Condition=="Vines in the crown")%>% 
  left_join(QCVines %>% select(Plot_Name,Sample_Year,Tag=Host_Tag, Vine= Latin_Name )) %>% 
  filter(is.na(Vine) | Vine=="") %>% 
  select(Unit_Code, Plot_Name, Sample_Year, Tag, Status,  Condition, Vine)


### Multi-Year Checks

Repeat_Trees<-QCTrees %>% group_by(Tag) %>% summarize(Records=n()) %>% filter(Records>1) %>% pull(Tag)

#Status  Change 
Trees_Start_Wrong<-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any(Sample_Year==min(Sample_Year) & (Status  %in% c(Missing_Status, Other_Status, "Dead Fallen")) | 
           (Status %in% Dead_Status & Sample_Year < 2010 )) ) %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
  select(Plot_Name, Cycle, Tag, Latin_Name, Status, Start_Year) %>% 
    pivot_wider(id_cols=c(Plot_Name, Tag, Latin_Name, Start_Year) , names_from = Cycle, 
                names_prefix = "Cycle ", values_from = Status)} else data.frame()

Trees_Dead_Fallen_Plus<-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any(Sample_Year!=max(Sample_Year) & Status=="Dead FAllen")) %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, Status, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = Status, names_from = Cycle ) } else data.frame()

Trees_Reanimated<-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any(Status %in% Dead_Status & lead(Status, order_by=Sample_Year) %in% c(Live_Status, Other_Status, Missing_Status ))) %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, Status, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = Status, names_from = Cycle ) } else data.frame()
  
Trees_Levitated<-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any(Status =="Alive Fallen" & lead(Status, order_by=Sample_Year) %in% c("Alive Broken", "Alive Leaning", "Alive Standing",
                                                           "Dead Leaning", "Dead Standing"))) %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, Status, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = Status, names_from = Cycle ) } else data.frame()

Trees_Found_Alive<-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any( (Status %in% Missing_Status) & (lead(Status, order_by=Sample_Year) %in% Live_Status) )) %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, Status, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = Status, names_from = Cycle ) } else data.frame()

Trees_Downgraded_Fallen <-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any( (Status =="Downgraded to Non-Sampled") & (lead(Status, order_by=Sample_Year) == "Dead Fallen") )) %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, Status, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = Status, names_from = Cycle ) } else data.frame()


Trees_Downgraded_Missing <-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any( (Status =="Downgraded to Non-Sampled") & (lead(Status, order_by=Sample_Year) %in% Missing_Status) )) %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, Status, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = Status, names_from = Cycle ) } else data.frame()

Trees_Triple_Missing <-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any( (Status %in% Missing_Status) & (lead(Status, order_by=Sample_Year) %in% Missing_Status)
              & (lead(Status,n=2, order_by=Sample_Year) %in% Missing_Status))) %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, Status, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = Status, names_from = Cycle ) } else data.frame()

## Vigor Change

Trees_Vigor_Jump <-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any( 
    (VigorClass =="Moderate Decline" & lead(Status, order_by=Sample_Year) == "Healthy") |
    (VigorClass =="Functionally Dead" & lead(Status, order_by=Sample_Year) %in% c("Healthy", "Light Decline"))
    )) %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, VigorClass, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = VigorClass, names_from = Cycle ) } else data.frame()

## Crown Class Change

Trees_Open_Grown_Change <-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any( Crown_Description =="Open-grown" & (lead(Status, order_by = Sample_Year) %in% Live_Status & 
                                            lead(Crown_Description, order_by=Sample_Year) != "Open-grown")))  %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, Crown_Description, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = Crown_Description, names_from = Cycle ) } else data.frame()

Trees_Dom_to_Less <-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any( Crown_Description %in% c("Dominant", "Co-dominant") & (lead(Status, order_by = Sample_Year) %in% Live_Status & 
                     !lead(Crown_Description, order_by=Sample_Year) %in%  c("Dominant", "Co-dominant"))))  %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, Crown_Description, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = Crown_Description, names_from = Cycle ) } else data.frame()

Trees_IntOver_to_Other <-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any( Crown_Description %in% c("Intermediate", "Overtopped") & (lead(Status, order_by = Sample_Year) %in% Live_Status & 
                     lead(Crown_Description, order_by=Sample_Year) %in%  c("Edge Tree", "Open-grown"))))  %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, Crown_Description, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = Crown_Description, names_from = Cycle ) } else data.frame()

Trees_EdgeGap_to_Open <-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any( Crown_Description %in% c("Light Gap Exploiter", "Edge Tree") & 
      (lead(Status, order_by = Sample_Year) %in% Live_Status & lead(Crown_Description, order_by=Sample_Year) =="Open-grown")))%>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, Crown_Description, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = Crown_Description, names_from = Cycle ) } else data.frame()

## Tree Diameter Change

Trees_Live_Large_DBH_change <-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any(Status %in% Live_Status & lead(Status, order_by = Sample_Year) %in% Live_Status & 
          abs(Equiv_Live_DBH_cm -lead(Equiv_Live_DBH_cm, order_by=Sample_Year) > 3))) %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, LiveDBH=Equiv_Live_DBH_cm, Stems, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = c(Stems, LiveDBH), names_from = Cycle, names_sep = " " ) } else data.frame()

Trees_Dead_Large_DBH_change <-if(length(Repeat_Trees>0)){
  QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
  group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
  filter(any(Status %in% Dead_Status & Stems > 0 &
        lead(Status, order_by = Sample_Year) %in% Dead_Status & lead(Stems, order_by = Sample_Year) > 0 &
          abs(Equiv_Dead_DBH_cm -lead(Equiv_Dead_DBH_cm, order_by=Sample_Year) > 3))) %>% 
  mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
   select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, DeadDBH=Equiv_Dead_DBH_cm, Stems, Start_Year) %>% 
   pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
               values_from = c(Stems, DeadDBH), names_from = Cycle, names_sep = " " ) } else data.frame()

# Trees_Start_Too_Large <-if(length(Repeat_Trees>0)){
#   QCTrees %>% filter(Tag %in% Repeat_Trees) %>% 
#   group_by(Tag) %>% arrange(Tag, Sample_Year) %>% 
#   filter(any(Status %in% Live_Status & Stems > 0 & Equiv_Live_DBH_cm >13 & is.na(lag(Equiv_Live_DBH_cm, order_by=Sample_Year))
#              &!is.na(lag(, order_by = Sample_Year)) 
#              )) %>% 
#   mutate(Start_Year=min(Sample_Year)) %>% arrange(Sample_Year) %>% 
#    select(Plot_Name, Cycle, Sample_Year, Tag, Latin_Name, LiveDBH=Equiv_Live_DBH_cm, Stems, Start_Year) %>% 
#    pivot_wider(id_cols = c(Plot_Name, Tag, Latin_Name, Start_Year), names_prefix = "Cycle ",
#                values_from = c(Stems, LiveDBH), names_from = Cycle, names_sep = " " ) } else data.frame()

```


- dead trees wth > 1cm live dbh should not exist in a microplot as it would be a sapling (need distance / azimuth)

#### **Trees Checked:** `r TotTrees` ####
#### **Stems Checked:** `r TotStems` ####

###  Tree Status
```{r Tree_Status, echo=FALSE, hold=FALSE, results="asis"}

if(nrow(Trees_Bad_Status)==0) cat("All tree records checked have a valid status.<br>") else {
   errorText("Tree records without a status or a status we do not use:"); NiceTable(Trees_Bad_Status)}

```

---

### Species ID

```{r Tree_Species, echo=FALSE, hold=FALSE, results="asis"}
 
 if(nrow(Trees_No_Name)==0) cat("All tree records checked have a species ID.<br>") else {
    errorText("Tree records with no species name:"); NiceTable(Trees_No_Name)}

```


---

### Tree Tag

```{r Tree_Tag, echo=FALSE, hold=FALSE, results="asis"}
 if(nrow(Trees_Bad_Tag)==0) cat("All tree records have a valid tag.<br>") else {
    errorText("Tree records with no tag or a tag <1 or >30,000 tag:"); NiceTable(Trees_Bad_Tag)}

```

---

### Tree Crown

```{r Tree_Crown, echo=FALSE, hold=FALSE, results="asis"}
 cat("<br>**Living Trees' Crown Description**<br>")
 if(nrow(Trees_Live_Bad_Crown)==0) cat("All tree records have a valid crown description.<br>") else {
    errorText("Living Tree records with a mising crown description or one we do not use:"); NiceTable(Trees_Live_Bad_Crown)}

cat("<br>**Non-Living Trees' Crown Description**<br>")
 if(nrow(Trees_Unalive_Bad_Crown)==0) cat("All tree records checked and no non-living trees have a crown description.<br>") else { 
    errorText("Non-living tree records with a crown description:"); NiceTable(Trees_Unalive_Bad_Crown)}
```

---

### Tree Diameter

```{r Tree_Diameter, echo=FALSE, hold=FALSE, results="asis"}
cat("<br>**DBH Check**<br>")
 if(nrow(Trees_Bad_DBH_Check)==0) cat("No tree records have an inappropriate DBH check.<br>") else { 
    errorText("Tree records with the DBH check box checked before that was done or for tree with no DBH:"); NiceTable(Trees_Bad_DBH_Check)}

cat("<br>**Living Tree DBH Incorrect**<br>")
 if(nrow(Trees_Live_Bad_DBH)==0) cat("No live tree records have an invlid DBH.<br>") else { 
    errorText("Live tree records with a living or dead DBH < 10cm:"); NiceTable(Trees_Live_Bad_DBH)}

cat("<br>**Dead Tree DBH Incorrect**<br>") 
if(nrow(Trees_Dead_Bad_DBH)==0) cat(" No dead tree records have an invlid DBH.<br>") else { 
    errorText("Dead tree records with a dead DBH <10cm:"); NiceTable(Trees_Dead_Bad_DBH)}

cat("<br>**DBH Wrongly Recorded**<br>")
if(nrow(Trees_Other_Bad_DBH)==0) cat("No tree records have a DBH when they should not.<br>") else { 
    errorText("Tree records with a DBH that should not have one:"); NiceTable(Trees_Other_Bad_DBH)}

```

---


### Stem Diameter

```{r Tree_Stem_Diameter, echo=FALSE, hold=FALSE, results="asis"}
cat("<br>**Living Stem DBH Incorrect**<br>")
 if(nrow(Tree_Stems_Live_Bad_DBH)==0) cat("No live tree stems have an invlid DBH.<br>") else { 
    errorText("Live tree stem records with a missing DBH or a DBH <1 cm:"); NiceTable(Tree_Stems_Live_Bad_DBH)}

cat("<br>**Dead Stem DBH Incorrect**<br>")
 if(nrow(Tree_Stems_Dead_Bad_DBH)==0) cat("No dead tree stems have an invlid DBH.<br>") else { 
    errorText("Dead tree stem records with a missing DBH or a DBH <10 cm:"); NiceTable(Tree_Stems_Dead_Bad_DBH)}

cat("<br>**Stem DBH Wrongly Recorded**<br>") 
 if(nrow(Tree_Stems_Other_Bad_DBH)==0) cat("Mo tree stems have a DBH when they should not.<br>") else { 
    errorText("Tree stem records with a DBH on a tree that should not have any DBH:"); NiceTable(Tree_Stems_Other_Bad_DBH)}

```

---

### Tree Vigor

```{r Tree_vigor, echo=FALSE, hold=FALSE, results="asis"}
 
cat("<br>**Living Tree Vigor Invalid**<br>")
 if(nrow(Trees_Live_Bad_Vigor)==0) cat("All live trees have a valid vigor.<br>") else {
    errorText("Living tree records with a vigor other than 0-5:"); NiceTable(Trees_Live_Bad_Vigor)}

cat("<br>**Non-Living Trees with Vigor**<br>")
 if(nrow(Trees_Unalive_Bad_Vigor)==0) cat("No non-living trees have a vigor.<br>") else {
    errorText("Non-living tree records with a vigor:"); NiceTable(Trees_Unalive_Bad_Vigor)}

```

---

### Tree Foliage

```{r Tree_Foliatge, echo=FALSE, hold=FALSE, results="asis"}
 
cat("<br>**Living Tree Foliage Conditions**<br>")
  if(nrow(Trees_Bad_Foliage_Condition)==0) cat("All live tree foliage conditions are valid. <br>") else {
     errorText("Living tree records with invalid foliage conditions:"); NiceTable(Trees_Bad_Foliage_Condition)}
  
cat("<br>**Living Tree Foliage Percent**<br>")
  if(nrow(Trees_Bad_Foliage_Condition)==0) cat("All foliage percents on live trees are valid.<br>") else {
     errorText("Living tree records with invalid foliage percents:"); NiceTable(Trees_Bad_Foliage_Percent)}

cat("<br>**Non-Living Tree Foliage Conditions**<br>")  
  if(nrow(Trees_Unalive_Foliage)==0) cat("No non-living trees have foliage condiditons.<br>") else {
     errorText("Non-living tree records with foliage conditions:"); NiceTable(Trees_Unalive_Foliage)}
```

---

### Tree Conditions

```{r Tree_Conditions, echo=FALSE, hold=FALSE, results="asis"}
 
cat("<br>**Living Tree Conditions**<br>")
if(nrow(Trees_Live_Bad_Tree_Condition)==0) cat("All tree conditions are valid.") else {
     errorText("Living tree records with a tree condition we don't monitor:"); NiceTable(Trees_Live_Bad_Tree_Condition)}

cat("<br>**Anachronistic Tree Conditions**<br>")
if(nrow(Trees_Live_Anachronistic_Tree_Conditions)==0) cat("All tree conditions are from the correct year.<br>") else {
  errorText("Living tree records with a tree condition from the wrong year:"); NiceTable(Trees_Live_Anachronistic_Tree_Conditions)}

cat("<br>**Non-Living Tree Conditions**<br>")
if(nrow(Trees_Unalive_Tree_Conditions)==0) cat("No non-living trees have tree-conditions.<br>") else { 
  errorText("Non-living tree records with a tree condition:"); NiceTable(Trees_Unalive_Tree_Conditions)}

cat("<br>**Vines in the Crown vs. Vines**<br>")
if(nrow(Trees_Bad_Vines)==0) cat("All tree records with vines in the crown had vine species recorded.<br>") else { 
  errorText("Tree records with vines in the crown but no corresponding vine record:"); NiceTable(Trees_Bad_Vines)}
```

---

### Tree Pests

```{r Tree_Pests, echo=FALSE, hold=FALSE, results="asis"}
 
cat("<br>**Living Tree Pests**<br>")
if(nrow(Trees_Live_Bad_Pest)==0) cat("All pest records from live trees are valid.<br>") else {
     errorText("Living tree records with a pest we don't monitor:"); NiceTable(Trees_Live_Bad_Pest)}

cat("<br>**Anachronistic Pests**<br>") 
 if(nrow(Trees_Live_Anachronistic_Pest)==0) cat("No pests recorded before we started monitoring them.<br>") else {
   errorText("Living tree records with a pest from the wrong year:"); NiceTable(Trees_Live_Anachronistic_Pest)}
 
cat("<br>**Non-Living Tree Pests**<br>")
 if(nrow(Trees_Unalive_Pest)==0) cat("No non-living trees have pests (except for EAB).<br>") else {
   errorText("Non-living tree records with a pest other than EAB:"); NiceTable(Trees_Unalive_Pest)}

cat("<br>**Mis-matched Tree Pests**<br>")
 if(nrow(Trees_Pest_Bad_Host)==0) cat("No pests on incorrect host species.<br>") else {
   errorText("Trees with inconsistent host species - pest pairs:"); NiceTable(Trees_Pest_Bad_Host)}

```

---

### **Change Over Time**

### Tree Status Discrepancies

```{r Tree_Status_Change, echo=FALSE, hold=FALSE, results="asis"}

cat("<br>**Trees that Start in a Non-Sampled Status**<br>")
 if(nrow(Trees_Start_Wrong)==0) cat("No tree start as missing downgraded, or dead fallen.<br>") else {
   errorText("Trees that start in a non-sampled status:"); NiceTable(Trees_Start_Wrong)}

cat("<br>**Trees that are Sampled after they are Dead Fallen**<br>")
 if(nrow(Trees_Dead_Fallen_Plus)==0) cat("No tree is sampled after it is dead fallen.<br>") else {
   errorText("Trees that are sampled after they are dead fallen:"); NiceTable(Trees_Dead_Fallen_Plus)}

cat("<br>**Trees that have Risen from the Dead**<br>")
 if(nrow(Trees_Reanimated)==0) cat("No tree was reanimated after it died.<br>") else {
   errorText("Trees that died but did not stay dead:"); NiceTable(Trees_Reanimated)}

cat("<br>**Trees that Fell Down and then Levitated Back Up**<br>")
 if(nrow(Trees_Levitated)==0) cat("No tree was Alive Fallen and then became Standing or Leaning.<br>") else {
   errorText("Trees that were Alive Fallen but then became Standing or Leaning:"); NiceTable(Trees_Levitated)}

cat("<br>**Trees that went Missing and were Found Alive**<br>")
 if(nrow(Trees_Found_Alive)==0) cat("No tree was Missing and then found Alive.<br>") else {
   errorText("Trees that were Missing but then were found Alive:"); NiceTable(Trees_Found_Alive)}

cat("<br>**Trees that went from Downgraded to Dead Fallen**<br>")
 if(nrow(Trees_Downgraded_Fallen)==0) cat("No tree went from Downgraded to Dead Fallen.<br>") else {
   errorText("Trees that were Downgraded but then were marked Dead Fallen:"); NiceTable(Trees_Downgraded_Fallen)}

cat("<br>**Trees that went from Downgraded to Missing**<br>")
 if(nrow(Trees_Downgraded_Missing)==0) cat("No tree went from Downgraded to Missing.<br>") else {
   errorText("Trees that were Downgraded but then went Missing:"); NiceTable(Trees_Downgraded_Missing)}

cat("<br>**Trees that went Missing Three Times in a Row**<br>")
 if(nrow(Trees_Triple_Missing)==0) cat("No tree went missing 3 consecutive visits.<br>") else {
   errorText("Trees that were Missing three times in a row:"); NiceTable(Trees_Triple_Missing)}
```

---

### Tree Vigor Cahnge
```{r Tree_Vigor_Change, echo=FALSE, hold=FALSE, results="asis"}

cat("<br>**Trees that have a Large Improvement in Vigor**<br>")
 if(nrow(Trees_Vigor_Jump)==0) cat("No tree has a 2 class improvement in vigor.<br>") else {
   errorText("Trees that have a 2 class improvement in vigor:"); NiceTable(Trees_Vigor_Jump)}
```

---

### Tree Crown Change
```{r Tree_Crown_Change, echo=FALSE, hold=FALSE, results="asis"}

cat("<br>**Trees that stop being Open Grown**<br>")
 if(nrow(Trees_Open_Grown_Change)==0) cat("No tree has changed from Open Grown.<br>") else {
   errorText("Trees that have chagned from Open Grown:"); NiceTable(Trees_Open_Grown_Change)}

cat("<br>**Trees that are no longer Dom / Co-dom**<br>")
 if(nrow(Trees_Dom_to_Less)==0) cat("No tree has dropped from dominant/co-dominant status.<br>") else {
   errorText("Trees that have chagned from dominant/co-dominant status:"); NiceTable(Trees_Dom_to_Less)}

cat("<br>**Trees that went from Intermediate/Overtopped to Edge or Open Grown**<br>")
 if(nrow(Trees_IntOver_to_Other)==0) cat("No tree has gone from Intermeidate/Overtoped to Edge or Open Grown.<br>") else {
   errorText("Trees that went from Intermediate/Overtopped no Edge or Open Grown:"); NiceTable(Trees_IntOver_to_Other)}

cat("<br>**Trees that went from Edge Tree/ Light Gap to Open Grown**<br>")
 if(nrow(Trees_EdgeGap_to_Open)==0) cat("No tree has gone from Edge Tree/ Light Gap to Open Grown.<br>") else {
   errorText("Trees that went from Edge Tree/Light Gap to Open Grown:"); NiceTable(Trees_EdgeGap_to_Open)}

```

---

### Tree DBH Change
```{r Tree_Live_DBH_Change, echo=FALSE, hold=FALSE, results="asis"}

cat("<br>**Trees that have a large change in Live DBH**<br>")
 if(nrow(Trees_Live_Large_DBH_change)==0) cat("No tree has had a 3cm change in live DBH.<br>") else {
   errorText("Trees that have had a 3cm change in live DBH:"); NiceTable(Trees_Live_Large_DBH_change)}

cat("<br>**Trees that have a large change in Dead DBH**<br>")
 if(nrow(Trees_Dead_Large_DBH_change)==0) cat("No tree has had a 3cm change in dead DBH.<br>") else {
   errorText("Trees that have had a 3cm change in dead DBH:"); NiceTable(Trees_Dead_Large_DBH_change)}

cat("<br>**Trees that have a large starting DBH**<br>")
 if(nrow(Trees_Start_Too_Large)==0) cat("No tree starts with a >13cm DBH after a plot is established.<br>") else {
   errorText("Trees that start with a >13cm DBH after a plot is established:"); NiceTable(Trees_Start_Too_Large)}


```



