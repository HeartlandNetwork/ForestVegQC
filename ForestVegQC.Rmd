---
title: "NCRN Forest Vegetation QC"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(NPSForVeg)
library(tidyverse)
library(DT)
library(lubridate)

options(htmlwidgets.TOJSON_ARGS = list(na = 'string'))

NiceTable<-function(DF){
   

   datatable(DF, rownames = F, extensions = "Buttons", autoHideNavigation = T, options=list(
      columnDefs=list(list(className='dt-center', targets=0:ncol(DF)-1 )),
      pageLength=25,
      dom='Btip',
      buttons=c('copy','csv'))
   )}

errorText<-function(text) {cat(paste0("<span style='color:red;'>",text,"</span><br>"))}

DataDir<-"C:/Users/jschmit/Desktop/Some data/Veg_NCRN"
NCRN<-importNCRN(DataDir)


QCYears<-c(2006:2017)


QCPlots<-getPlots(NCRN, years = QCYears,type="all" ) %>% mutate(Aspect= as.numeric(Aspect))
QCEvents<-getEvents(NCRN, years = QCYears) 
QCPlotFloor<-read.csv("C:/Users/jschmit/Desktop/Some data/Veg_NCRN/Plot_Floor.csv", stringsAsFactors = F) %>% filter(Sample_Year %in% QCYears)
QCCWD<-getPlants(NCRN, "cwd", years=QCYears)
QCTrees<-getPlants(NCRN,"trees", years=QCYears, status = "all")
QCStems<-read.csv(paste0(DataDir,"/Stems.csv"), stringsAsFactors = F)
QCFoliage<-read.csv(paste0(DataDir,"/Foliage_Conditions.csv"), stringsAsFactors = F)
QCConditions<-read.csv(paste0(DataDir,"/Tree_Sapling_Conditions.csv"), stringsAsFactors = F)
QCVines<-getPlants(NCRN,"vines",  years=QCYears )
QCSaplings<-getPlants(NCRN, "saplings",  years=QCYears, status="all")
QCShrubs<-getPlants(NCRN, "shrubs",  years=QCYears, status="all")
QCQuads<-read.csv(paste0(DataDir,"/Quadrat_Conditions.csv"), stringsAsFactors = F)
QCSeedlings<-rbind(getPlants(NCRN,"seedlings", years=QCYears),getPlants(NCRN,"shseedlings", years=QCYears) )
QCHerbs<-getPlants(NCRN, "herbs", years=QCYears)

Live_Status<-c("Alive Broken", "Alive Fallen", "Alive Leaning", "Alive Standing")
Dead_Status<-c("Dead", "Dead - Human Action", "Dead - Too Small", "Dead Fallen", "Dead Leaning", "Dead Missing", "Dead Standing")
Missing_Status<-c("Missing", "Missing - Presumed Dead", "Missing - Uncertain")
Other_Status<-c( "Downgraded to Non-Sampled")

Vigor_Options<-c("Healthy", "Light Decline", "Moderate Decline", "Functionally Dead")


```



```{css, echo=FALSE}
h1, h2, h3 {
  text-align: center;
}

.nav>li>a {
   padding: 10px;
}
```

#  {.tabset .tabset-pills .tabset-fade}

## Introduction

**Run on:** `r format(Sys.Date(),"%B %d %Y") `.

**Years covered:** `r paste0(min(QCYears),"-", max(QCYears)) `.


### The following data is not currently QCed:

#### All
- Flags are not exported from the database and are not considered during QC.

#### Plots
- Retired date for retired plots not currently exported.

#### Events
- Need to export table that matches years with panels so we can verify the correct plots were sampled.

- Pictures taken not exported. Need to decide how to check files on drive. 

- CWD check not exported.

- Deer Impact value not exported.


#### CWD
- Need a mechanism to check if Latin names are reasonable

- Need to export tree tags to make sure they correpond to a local tree/ sapling

#### Trees
- Need  a mechanism to check if Latin names are reasonable

- Need a way to check that tree tag is not retired

- Need to export the foliage conditions, tree conditions and vines checkboxes. Need to verify they are checked for living trees and dead trees with EAB have conditions checked, but not checked in other cases.

- Trees (and saplings) with no conditions are still listed in the Tree_Sapling_Conditions export - is that desireable? This is not true of Shrubs

- Need to export distance and azimuth to verify these are credible and check for sapling accidentaly recoreded as a tree.

- Export does not distinguish between live and dead stems

#### Saplings
- Need  a mechanism to check if Latin names are reasonable

- Need to export the foliage conditions, tree conditions and vines checkboxes. Need to verify they are checked for living saplings and dead saplings with EAB have conditions checked from 2015? on, but not checked in other cases.

- Equivalent diameter is not exported for dead stems of saplings (this will typcially = 0)

- In Foliage_Conditions export there is no way to separate saplings and shrubs from trees (compare to stems export which has Habit and Class fields )

- In Tree_Conditions export there is no way to separate saplings and shrubs from trees (compare to stems export which has Habit and Class fields )

- In Vines export there is no way to separate saplings and shrubs from trees (compare to stems export which has Habit and Class fields )

- Microplot # is not exported (60, 180, 300)

- Dead shrubs with no "habit" are exported as saplings

- Dead stems not exported

#### Shrubs
- Need  a mechanism to check if Latin names are reasonable

- Need to export the foliage conditions, tree conditions and vines checkboxes. Need to verify they are checked for living shrubs, and  have conditions checked from 2015? on, but not checked in other cases.

- Shrub DRC and stems are not exported (should they be?)

- Equivalent diameter is not exported for dead stems of saplings (this will typcially = 0)

- In Foliage_Conditions export there is no way to separate saplings and shrubs from trees (compare to stems export which has Habit and Class fields )

- In Tree_Conditions export there is no way to separate saplings and shrubs from trees (compare to stems export which has Habit and Class fields )

- In Vines export there is no way to separate saplings and shrubs from trees (compare to stems export which has Habit and Class fields )

- Microplot # is not exported (60, 180, 300)

#### Vines
- Need  a mechanism to check if Latin names are reasonable

-  A way to distinguish between tree, sapling and shrub tags

#### Quads
- Need to export table that matches years with panels so we can verify the correct quads were sampled.

#### Seedlings
- Need  a mechanism to check if Latin names are reasonable

- Need to export table that matches years with panels so we can verify the correct plots/quads were sampled.

#### Herbs
- Need  a mechanism to check if Latin names are reasonable

- Need to export table that matches years with panels so we can verify the correct plots/quads were sampled.

- Need to export Herb browsable and browse data

## Plots


```{r Plot-QC, child="ForestVegPlotsQC.Rmd"}
```


## Events

```{r Event-QC, child="ForestVegEventsQC.Rmd"}
```
 
## Plot Floor

```{r Plot_Floor-QC, child="ForestVegPlotFloorQC.Rmd"}
```

## CWD 

```{r CWD-QC, child="ForestVegCWDQC.Rmd"}
```
 
## Trees

```{r Tree-QC, child="ForestVegTreeQC.Rmd"}
```


## Saplings

```{r Sapling-QC, child="ForestVegSaplingQC.Rmd"}
```


## Shrubs

```{r Shrub-QC, child="ForestVegShrubQC.Rmd"}
```


## Vines

```{r Vine-QC, child="ForestVegVineQC.Rmd"}
```


## Quadrats

```{r Quad-QC, child="ForestVegQuadsQC.Rmd"}
```


## Seedlings

```{r Seedling-QC, child="ForestVegSeedlingQC.Rmd"}
```

## Herbs

```{r Herb-QC, child="ForestVegHerbQC.Rmd"}
```

## Change over time

### Events

Only data here to check is deer impact but unclear if there is a good check. Need to investigate how this changes over time. 

### Trees

- After 1st time monitoring a plot there should be limits on the size of new stems (>= 13 cm?) As stems are not tracked individually this is tricky but if you go from 1 to 2 and both stems are 20cm this is a problem - this applies to both living and dead stems. Errors here could potentially be explained by mis-checking the live /dead stem checkbox for multi-stemmed trees.


Tree Conditions

- Tree Condition EAB - this seems permanent at this point, any change from present to absent should be flagged - unless maybe tree is dead(?)
- Tree Condition Dogwood Antracnose - Do we think trees can recover form this? If not - flag if one does.
- Tree Condition Exposed Roots - this seems very unlikely to go away - should this be flagged if it does?
- Tree Condition Hemlock Scale - this seems permanent at this point wihtout treatment, any change from present to absent should be flagged - unless maybe tree is dead(?)
- Tree Condition Hemlock Wooly Adelgid - this seems permanent at this point wihtout treatment, any change from present to absent should be flagged - unless maybe tree is dead(?)
- Tree Condition Hollow - seems like if a tree is hollow and does not lose stems it should stay hollow - flag if not so?
- If Vines in crown goes awaye - check. It could happen but is worth checking
- If Vine Stress goes away - check - could happen but seems unliikly

- Compare the number of conditions on a tree in the same way we compare the number of vines on a tree. May not be wrong and is somewhat subjective but 
 might want to try and see if these change much cycle to cycle.

### Vines

- Currently QC picks up any instance where change in vines in >0 species on live trees / saplings / shrubs (when there are 2 sets of saplings /shrubs/ vines)  When if ever should this be a flag?
- Current QC reports # of vines in the plot currently and 4 years ago - is this ever a flag?


### Saplings 

- Around 750 saplings and shrubs not currently exported due to not having habit filled in. 
Bad or Suspicious Status Changes
- Dead to anything else (should not even be in data)
- Alive Fallen to any Standing or Leaning
- Any Missing, particularly Missing Presumed Dead to any Alive
- Can Downgraded to non-sampled go straight to Dead Fallen? 
- Downgraded to Non-Sampled to any Missing
- 3rd consecutive Missing - these should no longer be getting new data

- Sapling Vigor -Like trees - flag a change of 2? Or is life more dynamic for saplings

- Sapling dbh and condiitons - same general checks as trees


### Shrubs

Bad or Suspicious Status Changes

- Dead to anything else (should not even be in data)
- Alive Fallen to any Standing or Leaning
- Any Missing, particularly Missing Presumed Dead to any Alive
- Can Downgraded to non-sampled go straight to Dead Fallen? 
- Downgraded to Non-Sampled to any Missing
- 3rd consecutive Missing - these should no longer be getting new data

- Shrub Vigor -Like trees - flag a change of 2? Or is life more dynamic for saplings

- Shrub drc and condiitons - same general checks as trees (do we check the old drc measures?)



### Quad General Data

- Percent_Tree - If a quad changes by more than X percent: flag - need to define X
- Percent_Rock - If a quad changes by more than X percent: flag - need to define X
- Percent Grass/Sedge/Herb/Fern/Bryophyte - need to determine how much these change and if they are consistent enough for QC

### Seedlings

Seedling number / height/ species - need to determine if these are consistent enoough between samples for QC or not


### Herbs

- Current QC looks at large changes in herb %, additions of species and loss of species - are herb % consistent enough between samples 
 to use as QC? What about speices lists? Need to check data.

